name: Build & Approve Paper Plugin

on:
  push:
    paths:
      - 'pom.xml'
      - 'plugin.yml'
  workflow_dispatch: # you can still run manually anytime

jobs:
  detect-and-wait:
    name: ğŸ” Detect version updates
    runs-on: ubuntu-latest
    outputs:
      can_build: ${{ steps.check.outputs.can_build }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ§© Read versions
        id: versions
        run: |
          pom_version=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          plugin_version=$(grep -m1 'version:' plugin.yml | sed 's/version: //')
          echo "pom_version=$pom_version" >> $GITHUB_ENV
          echo "plugin_version=$plugin_version" >> $GITHUB_ENV
          echo "pom_version=$pom_version"
          echo "plugin_version=$plugin_version"

      - name: ğŸ§  Check version conditions
        id: check
        run: |
          pom_changed=$(git diff --name-only HEAD~1 HEAD | grep -c 'pom.xml' || true)
          plugin_changed=$(git diff --name-only HEAD~1 HEAD | grep -c 'plugin.yml' || true)

          if [ "$pom_changed" -eq 1 ] && [ "$plugin_changed" -eq 1 ]; then
            if [ "$pom_version" = "$plugin_version" ]; then
              echo "âœ… Versions match ($pom_version) and both changed."
              echo "can_build=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Version mismatch between pom.xml ($pom_version) and plugin.yml ($plugin_version)"
              echo "can_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ One or both version files were not changed."
            echo "can_build=false" >> $GITHUB_OUTPUT
          fi

  build-and-publish:
    name: âš™ï¸ Build & Publish (Requires Approval)
    runs-on: ubuntu-latest
    needs: detect-and-wait
    if: needs.detect-and-wait.outputs.can_build == 'true'
    environment:
      name: production
      # You must set this environment in your repo settings and require manual approval.
      # Settings âœ Environments âœ production âœ Required reviewers: Oliver (your account)
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: ğŸ§± Build with Maven
        run: mvn -B clean package --file pom.xml

      - name: ğŸš€ Publish to GitHub Packages
        run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

